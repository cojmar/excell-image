<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        .left {
            float: left;
        }

        textarea {
            height: 500px;
            width: 400px;
        }
    </style>
</head>

<body>
    <h4> HTML - export - svg 2 png convertor to base64 PNG ! WORKING !- excel doesn't recognize base64 images</h4>


    <div class="left">
        <table id="export_table" border="1px">
            <thead>
                <tr>
                    <th>name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Country</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th>1</th>
                    <td>2</td>
                    <td>3</td>
                    <td>4</td>

                </tr>
                <tr>
                    <td colspan="4">
                        <svg width="50" height="50" xmlns="http://www.w3.org/2000/svg">
                            <g>
                                <rect id="svg_1" height="30" width="30" y="5" x="5" stroke-width="1.5" stroke="#df0000"
                                    fill="#000000" />
                            </g>
                        </svg>
                    </td>
                </tr>
            </tbody>
        </table>
        <hr>
        <div>
            <button id="export_button">Export</button>
            <button id="js_array_button">Convert Array</button>            
            <button id="convert_button">Convert</button>
        </div>
    </div>
    <div class="left">
        <textarea id="input_area">
            INPUT TABLE
        </textarea>
    </div>
    <div class="left">
        <textarea id="output_area">
            CONVERTED IMAGES TABLE
        </textarea>
    </div>
    <br clear="all">
    <hr>
    <a href="working_real_excell_export.html">Real XCEL with base64 images working example</a>
    <hr>
    <h1>TO DO:</h1>
    <h2> MIX THIS 2 EXAMPLES FOR FINAL PRODUCT</h2>
    <script>
        class app {
            constructor() {
                this.table = 'export_table';
                document.getElementById('export_button').onclick = () => {
                    this.export(this.table, 'test.xls');
                }
                document.getElementById('convert_button').onclick = () => {
                    this.convert_areas();
                }
                document.getElementById('js_array_button').onclick = () => {
                    document.getElementById('input_area').value = `
                    [
                        {
                            name:"test",
                            image:\`<svg width="50" height="50" xmlns="http://www.w3.org/2000/svg">
                                        <g>
                                            <rect id="svg_1" height="30" width="30" y="5" x="5" stroke-width="1.5" stroke="#df0000" fill="#000000" />
                                        </g>
                                    </svg>\`,
                            "age":"0"

                        },
                        [
                            'a','b','<svg width="50" height="50" xmlns="http://www.w3.org/2000/svg"><g><rect id="svg_1" height="30" width="30" y="5" x="5" stroke-width="1.5" stroke="#df0000" fill="#000000" /></g></svg>',
                        ]
                    ]
                    `.split('                    ').join('');
                    this.convert_areas();
                }
                this.convert_example();
            }
            make_png_form_svg(svg_xml) {
                return new Promise((resolve, reject) => {
                    let png;
                    let canvas = document.createElement('canvas');
                    let ctx = canvas.getContext("2d");
                    let img = new Image();
                    img.src = "data:image/svg+xml;base64," + btoa(svg_xml);
                    img.onload = function () {
                        ctx.drawImage(img, 0, 0);
                        resolve(canvas.toDataURL("image/png"));
                    }
                });
            }
            convert_svg_to_png(html_string) {
                return new Promise((resolve, reject) => {
                    let temp = document.createElement("div");
                    temp.innerHTML = html_string;
                    let svgs = temp.getElementsByTagName("svg");
                    let done = 0;
                    let len = svgs.length;
                    for (let svg of svgs) {
                        let svg_text = svg.outerHTML;
                        this.make_png_form_svg(svg_text).then(
                            (png) => {
                                temp.innerHTML = temp.innerHTML.split(svg_text).join(`<img src="${png}"/ alt="">`);
                                done++
                                if (len - done <= 0) resolve(temp.innerHTML);
                            }
                        );
                    }
                });
            }
            convert_areas(){
                this.convert_svg_to_png(document.getElementById('input_area').value).then(converted => {
                    document.getElementById('output_area').value = `CONVERTED\n${converted}`;
                })
                return this;
            }
            convert_example() {
                document.getElementById('input_area').value = `${document.getElementById(this.table).outerHTML}`;
                this.convert_areas();
                return this;
            }
            export(tableId, file_name) {
                let table = document.getElementById(tableId).outerHTML;
                this.convert_svg_to_png(table).then((tableData) => {
                    let a = document.createElement('a');
                    let dataType = 'data:application/vnd.ms-excel';
                    a.href = `${dataType}, ${encodeURIComponent(tableData)}`
                    a.download = file_name;
                    a.click()
                });
                return this;
            }
        }
        new app();
    </script>
</body>

</html>